{% load staticfiles %}
{% load mptt_tags %}
{% load weibo_utils %}

<link rel="stylesheet" href="{% static 'editormd/css/editormd.min.css' %}">
<link rel="stylesheet" href="{% static 'editormd/css/editormd.preview.min.css' %}">

<div class="layui-card layui-card-body">
    <br/>
    <div>
        <div>
            <h1 style="color: black;font-size: xx-large; font-weight: bold; line-height: 110%">{{ article.title }}</h1>
            <br/>
            <p style="color: #8D8D8D;">{{ article.total_views }}阅读 · {{ article.readbook_comments.count }}评论 ·
                于{{ article.created|date:"Y年m月d日 H:i:s" }}发布

        </div>
        <br/>
        <div class="layui-col-xs12 layui-col-sm12 layui-col-md8 layui-col-lg6" id="book_box">
            <img src="{{ article.avatar_thumbnail.url }}" class="layui-col-sm3 layui-col-xs3"
                 style="margin: 10px; box-shadow: 1px 1px 3px black">
            <div class="layui-col-sm4 layui-col-xs8">
                <h3 style="color: #01a252; font-weight: bold; text-align: center; margin: 10px;">{{ article.title }}</h3>
                <p><span>作者：</span>{{ article.writer }}</p>
                <p><span>页数：</span>{{ article.book_page }}</p>
                <p><span>价格：</span>{{ article.price }}</p>
                <p><span>评分：</span>
                    {% include 'readbook/rate_base.html' %}</p>
                <p class="layui-text"><i class="layui-icon layui-icon-read"
                                         style="color: #01a252;"></i> {{ article.total_views }}
                    <i class="layui-icon layui-icon-dialogue"
                       style="color: #DE8E30;"></i> {{ article.readbook_comments.count }}
                <p id="practicality" hidden>{{ article.practicality }}</p>
                <p id="interesting" hidden>{{ article.interesting }}</p>
                <p id="readability" hidden>{{ article.readability }}</p>
                <p id="professionalism" hidden>{{ article.professionalism }}</p>
                <p id="binding_quality" hidden>{{ article.binding_quality }}</p>
            </div>
            <div class="layui-col-sm5 layui-hide-xs" id="echarts_book"
                 style="width:200px;height:200px"></div>
        </div>
        <hr/>
        <div id="editormd-view" class="layui-container">
        <textarea id="append-test" style="display: none;">
{{ article.body }}
        </textarea>
        </div>
    </div>
    <br/>
    <br/>
    <div style="text-align: center">
        <a href="/admiration/" target="_blank"
           class="layui-btn layui-btn-warm layui-btn-sm layui-btn-radius">写的不错，朕要赏</a>
    </div>
    <br/>
    <br/>

    {% if pre_article %}
        <a class="layui-btn layui-btn-sm" href="{{ pre_article.get_absolute_url }}"><< {{ pre_article.title }}</a>
    {% endif %}
    {% if next_article %}
        <a class="layui-btn layui-btn-sm" style="float: right;"
           href="{{ next_article.get_absolute_url }}">{{ next_article.title }} >></a>
        <br>
    {% endif %}

    <hr/>

    {#    发表评论#}
    {% if user.is_authenticated %}

        <div>
            <br>
            <form id="comment_form"
                  class="layui-form"
                  action="{% url 'comments:read_book_post_comment' article.id %}"
                  method="post">
                {% csrf_token %}
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label" for="id_body">发表评论： </label>
                    <div class="layui-input-block">
                                    <textarea rows="6"
                                              id="id_body" class="layui-textarea" name="body"
                                              placeholder="请输入评论内容"></textarea>
                    </div>
                </div>

                <input type="hidden" name="article_type" value="readbook">


                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button class="layui-btn layui-btn-sm layui-btn-primary" id="submit_btn" type="submit"
                                name="submit"><i class="layui-icon layui-icon-release"></i> 发布
                        </button>
                        <input type="hidden" name="next" value="{{ article.get_absolute_url }}"/>
                    </div>
                </div>
            </form>
        </div>

    {% else %}
        <br/>
        <br/>
        <div class="" style="text-align: center">
            <div>
                <div class="layui-text" style="font-size: large" id="weibologin"><span>登录后回复</span></div>
                <div class="" style="margin-top: 10px">
                        <span class="weibo mr-3">
                            <a href=/accounts/weibo/login/?process=login">
                                <i class="layui-icon layui-icon-login-weibo"
                                   style="font-size: xx-large; color: #ee771a;" aria-hidden="true"></i>
                            </a>
                        </span>
                </div>
            </div>
        </div>
    {% endif %}

    {#显示mptt层级评论#}
    <br/>
    <br/>
    <br/>
    <h2>共有{{ article.readbook_comments.count }}条评论</h2>

    <div>
        <ul>
            {% recursetree comments %}
                <div class="layui-row">
                    <hr/>
                    <div class="layui-col-xs2 layui-col-sm1 layui-text" id="F{{ node.id }}">
                        <div style="text-align: center">
                            {% if node.user.socialaccount_set.all.0.get_avatar_url %}
                                {% if node.reply_to %}
                                    <img src="{% translate_avatar_ssl node.user.socialaccount_set.all.0.get_avatar_url %}"
                                         style="width: 60%; border-radius: 20%">
                                {% else %}
                                    <img src="{% translate_avatar_ssl node.user.socialaccount_set.all.0.get_avatar_url %}"
                                         style="width: 80%; border-radius: 20%">
                                {% endif %}
                            {% else %}
                                {% if node.reply_to %}
                                    <img src="{% static 'default_avatar.jpg' %}"
                                         style="width: 60%; border-radius: 20%">
                                {% else %}
                                    <img src="{% static 'default_avatar.jpg' %}"
                                         style="width: 80%; border-radius: 20%">
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    <div class="layui-col-xs10 layui-col-sm11 layui-text">
                        {{ node.user }}
                        {% if node.user.is_superuser %}
                            <i style="color: #ff5500;">[博主]</i>
                        {% elif node.user.is_staff %}
                            <i style="color: #5897fb;">[管理员]</i>
                        {% endif %}
                        {% if node.reply_to %}
                            <i class="layui-icon layui-icon-next"></i> {{ node.reply_to }}
                            {% if node.reply_to.is_superuser %}
                                <i style="color: #ff5500;">[博主]</i>
                            {% elif node.user.is_staff %}
                                <i style="color: #5897fb;">[管理员]</i>
                            {% endif %}
                        {% endif %}
                        <pre style="font-family: inherit; font-size: 1.1em; color: black; padding-top: 6px">{{ node.body }}</pre>
                        <div style="color: #999999;"><p>{{ node.created_time|date:"Y-m-d H:i:s" }}
                            <a href="{% url 'comments:read_book_reply_post_comment' article.id node.id 'readbook' %}"
                               style="color: #01a252">回复</a></p></div>
                        {% if not node.is_leaf_node %}
                            <ul class="children">
                                {{ children }}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            {% endrecursetree %}
        </ul>
    </div>
</div>

<script src="{% static 'jquery.js' %}"></script>
<script src="{% static 'editormd/lib/marked.min.js' %}"></script>
<script src="{% static 'editormd/lib/prettify.min.js' %}"></script>
<script src="{% static 'editormd/lib/raphael.min.js' %}"></script>
<script src="{% static 'editormd/lib/underscore.min.js' %}"></script>
<script src="{% static 'editormd/lib/sequence-diagram.min.js' %}"></script>
<script src="{% static 'editormd/lib/flowchart.min.js' %}"></script>
<script src="{% static 'editormd/lib/jquery.flowchart.min.js' %}"></script>
<script src="{% static 'editormd/editormd.js' %}"></script>
<script src="{% static 'layui-v2.3.0/layui/layui.js' %}"></script>
<!-- 引入 ECharts -->
{#<script src="{% static 'echarts/echarts.js' %}"></script>#}
<script src="https://cdn.bootcss.com/echarts/4.1.0.rc2/echarts.js"></script>
<script src="{% static 'myjs.js' %}"></script>

<script type="text/javascript">
    editormd.emoji.path = "http://www.webpagefx.com/tools/emoji-cheat-sheet/graphics/emojis/"

    $(function () {
        editormd.markdownToHTML("editormd-view", {
            //htmlDecode      : true,       // 开启 HTML 标签解析，为了安全性，默认不开启
            htmlDecode: "style,script,iframe",  // you can filter tags decode
            //toc             : false,
            tocm: true,    // Using [TOCM]
            tocContainer: "#custom-toc-container", // 自定义 ToC 容器层
            //gfm             : false,
            //tocDropdown     : true,
            // markdownSourceCode : true, // 是否保留 Markdown 源码，即是否删除保存源码的 Textarea 标签
            emoji: true,
            taskList: true,
            tex: true,  // 默认不解析
            flowChart: true,  // 默认不解析
            sequenceDiagram: true,  // 默认不解析
        });
    });

    function weibo_login() {
        layui.use('layer', function () {
            var layer = layui.layer;

            layer.open({
                type: 2,
                area: ['650px', '600px'],
                content: '/accounts/weibo/login/?process=login'
            });
        });
    }

    var myChart = echarts.init(document.getElementById('echarts_book'));
    var practicality = document.getElementById('practicality').firstChild.nodeValue;
    var interesting = document.getElementById('interesting').firstChild.nodeValue;
    var readability = document.getElementById('readability').firstChild.nodeValue;
    var professionalism = document.getElementById('professionalism').firstChild.nodeValue;
    var binding_quality = document.getElementById('binding_quality').firstChild.nodeValue;
    // 指定图表的配置项和数据
    option = {
        tooltip: {},
        radar: {
            // shape: 'circle',
            name: {
                textStyle: {
                    color: '#fff',
                    backgroundColor: '#999',
                    borderRadius: 3,
                    padding: [3, 5]
                }
            },
            center: ['50%', '50%'],
            radius: 55,
            indicator: [
                {name: '实用', max: 5},
                {name: '趣味', max: 5},
                {name: '易读', max: 5},
                {name: '专业', max: 5},
                {name: '装订', max: 5},
            ]
        },
        series: [{
            name: '图书评分',
            type: 'radar',
            areaStyle: {
                normal: {
                    color: 'rgba(255, 240, 245, 1)'
                }
            },
            // areaStyle: {normal: {}},
            data: [
                {
                    value: [practicality, interesting, readability, professionalism, binding_quality],
                }
            ]
        }]
    };

    // 使用刚指定的配置项和数据显示图表。
    myChart.setOption(option);
</script>