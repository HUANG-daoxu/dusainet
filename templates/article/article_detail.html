{% extends 'base.html' %}
{% load staticfiles %}
{% load mptt_tags %}
{% block title %}文章列表{% endblock %}
{% block content %}
{#    md生成目录#}
    <div id="sidebar">
        <h1>文章目录</h1>
        <div class="markdown-body editormd-preview-container" id="custom-toc-container">#custom-toc-container</div>
    </div>
    <br/>
    <br/>
    <div class="layui-card layui-card-body">
        <div>
            <br/>
            <div class="">
                <h1 class="" style="font-size: xx-large; font-weight: bold">{{ article.title }}</h1>
                <br/>
                <p style="color: #8D8D8D;">{{ article.total_views }}阅读 · {{ article.total_comments }}评论 ·
                    于{{ article.created|date:"Y年m月d日 H:i:s" }}发布</p>
            </div>
            <link rel="stylesheet" href="{% static 'editormd/css/editormd.preview.css' %}">
            <div id="editormd-view" class="layui-container">
        <textarea id="append-test" style="display: none;">
{{ article.body }}
        </textarea>
            </div>
        </div>
        <hr>

        {#    发表评论#}
        <div>
            <h2>共有{{ article.total_comments }}条评论</h2>
            <br>
            <form id="comment_form"
                  class="layui-form"
                  action="{% url 'comments:post_comment' article.id %}"
                  method="post">
                {% csrf_token %}
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label" for="id_body">发表评论： </label>
                    <div class="layui-input-block">
                    <textarea rows="6"
                              id="id_body" class="layui-textarea" name="body"
                              placeholder="请输入评论内容"></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        {#                        <input class="layui-btn layui-btn-sm" id="submit_btn" type="submit" name="submit" value="发布"/>#}
                        <button class="layui-btn layui-btn-sm layui-btn-primary" id="submit_btn" type="submit"
                                name="submit"><i class="layui-icon layui-icon-release"></i> 发布
                        </button>
                        <input type="hidden" name="next" value="{{ article.get_absolute_url }}"/>
                    </div>
                </div>
            </form>
        </div>

        {#显示mptt层级评论#}
        <br/>
        <br/>
        <div>
            <ul>
                {% recursetree comments %}
                    <hr/>
                    <li class="layui-text">
                        <div>{{ node.user }}
                            {% if node.user.is_superuser %}
                                <i style="color: #ff5500;">[博主]</i>
                            {% endif %}
                            {% if node.reply_to %}
                                <i class="layui-icon layui-icon-reply-fill"></i> {{ node.reply_to }}
                                {% if node.reply_to.is_superuser %}
                                    <i style="color: #ff5500;">[博主]</i>
                                {% endif %}
                            {% endif %}
                        </div>
                    </li>
                    <li>

                        <div style="font-size: large">{{ node.body }}</div>

                        <div class="layui-text" style="color: #999999;"><p>{{ node.created_time|date:"Y年m月d日 H:i:s" }}
                            <a href="{% url 'comments:reply_post_comment' article.id node.id %}"
                               style="color: #01a252">回复</a></p></div>
                        {% if not node.is_leaf_node %}
                            <ul class="children layui-col-md-offset1">
                                {{ children }}
                            </ul>
                        {% endif %}
                    </li>
                {% endrecursetree %}
            </ul>
        </div>
    </div>

    <script src="{% static 'jquery.js' %}"></script>
    <script src="{% static 'editormd/lib/marked.min.js' %}"></script>
    <script src="{% static 'editormd/lib/prettify.min.js' %}"></script>
    <script src="{% static 'editormd/lib/raphael.min.js' %}"></script>
    <script src="{% static 'editormd/lib/underscore.min.js' %}"></script>
    <script src="{% static 'editormd/lib/sequence-diagram.min.js' %}"></script>
    <script src="{% static 'editormd/lib/flowchart.min.js' %}"></script>
    <script src="{% static 'editormd/lib/jquery.flowchart.min.js' %}"></script>
    <script src="{% static 'editormd/editormd.js' %}"></script>
    {#    <script src="{% static 'js/layer.js' %}"></script>#}


    <script type="text/javascript">
        $(function () {
            editormd.markdownToHTML("editormd-view", {
                //htmlDecode      : true,       // 开启 HTML 标签解析，为了安全性，默认不开启
                htmlDecode: "style,script,iframe",  // you can filter tags decode
                //toc             : false,
                tocm: true,    // Using [TOCM]
                tocContainer: "#custom-toc-container", // 自定义 ToC 容器层
                //gfm             : false,
                //tocDropdown     : true,
                // markdownSourceCode : true, // 是否保留 Markdown 源码，即是否删除保存源码的 Textarea 标签
                emoji: true,
                taskList: true,
                tex: true,  // 默认不解析
                flowChart: true,  // 默认不解析
                sequenceDiagram: true,  // 默认不解析
            });
        });


    </script>
    <style>
        #sidebar {
            width: 10%;
            height: 50%;
            position: fixed;
            top: 20%;
            right: 1%;
            overflow: hidden;
            background: #fff;
            z-index: 100;
            padding: 18px;
            border: 1px solid #ddd;
            border-top: none;
            border-bottom: none;
        }

        #sidebar:hover {
            overflow: auto;
        }

        #sidebar h1 {
            font-size: 16px;
        }

        #custom-toc-container {
            padding-left: 0;
        }

    </style>

{% endblock %}