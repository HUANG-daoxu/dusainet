{% load mptt_tags %}
{% load weibo_utils %}
{% load get_userinfo %}
{% load staticfiles %}
{% load filter_utils %}

<!-- ckeditor -->
<link rel="stylesheet" href="{% static 'ckeditor/ckeditor/plugins/prism/css/prism.css' %}">

<!-- 发表评论 -->
{% if user.is_authenticated %}
    <div>
        <form id="comment_form" action="{% url 'comments:post_comment' article.id %}" method="post">
            {% csrf_token %}
            <div>
                <h5>
                    发表评论：
                </h5>

                <!-- ckeditor 正文 -->
                {{ comment_form.body }}

            </div>

            <input type="hidden" name="article_type" value={{ article_type }}>
            <button id="comment_submit" type="submit" name="submit" hidden></button>
        </form>
        <div id="on_submit_outer" class="mt-2">
            <button class="btn btn-primary hvr-icon-bob" onclick="submit_comment('{% url 'comments:count_validate' %}')"
                    id="on_submit"><i class="fas fa-paper-plane hvr-icon"></i> 发布
            </button>
            <span id="comment_char_count" class="text-muted ml-2"></span>
            {% include 'utils/comment_submit.html' %}
        </div>
    </div>

{% else %}
    <br/>
    <br/>
    <div style="text-align: center">
        <div>
            <h5 class="text-muted" id="weibologin">
                <a href="{% url 'account_login' %}">
                    登录
                </a> 后回复
            </h5>
            <div style="text-align: center" class="container-fluid mb-4">
                <div>
                    <a href="/accounts/weibo/login/?process=login" class="mr-2" id="weibo_a">
                        <i class="fab fa-weibo" style="font-size: 3em; color: indianred;"></i>
                    </a>
                    <a href="/accounts/github/login/?process=login" id="github_a">
                        <i class="fab fa-github" style="font-size: 3em; color: dimgray;"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endif %}


<!-- 显示mptt层级评论 -->
<br>
<h5 id="Fcomments" class="mt-4 alert alert-info">共有{{ article.comments.count }}条评论</h5>
<div class="mb-2" id="comments_body" style="word-break: break-all">
    <div>
        {% recursetree comments %}
            <hr>
            <div class="row no-gutters" id="F{{ node.id }}">
                <div class="col-2 col-sm-1">
                    <div style="text-align: center">
                        {% get_userinfo node.user.id as userinfo %}
                        {% if node.user.socialaccount_set.all.0.get_avatar_url %}
                            <!-- 第三方头像 -->
                            <img src="{% translate_avatar_ssl node.user.socialaccount_set.all.0.get_avatar_url %}"
                                 alt="avatar"
                                    {% if node.reply_to %} style="width: 70%; border-radius: 20%" {% else %}
                                 style="width: 80%; border-radius: 20%" {% endif %}>
                        {% elif userinfo.avatar %}
                            <!-- 本地头像 -->
                            {% if 'static' in userinfo.avatar.url %}
                                <img src="{{ userinfo.avatar }}" alt="avatar" {% if node.reply_to %}
                                     style="width: 70%; border-radius: 20%" {% else %}
                                     style="width: 80%; border-radius: 20%"
                                {% endif %}>
                            {% else %}
                                <img src="{{ userinfo.avatar.url }}" alt="avatar" {% if node.reply_to %}
                                     style="width: 70%; border-radius: 20%" {% else %}
                                     style="width: 80%; border-radius: 20%"
                                {% endif %}>
                            {% endif %}
                        {% else %}
                            <!-- 无头像 -->
                            <img src="{% static 'default_avatar.jpg' %}" alt="avatar" {% if node.reply_to %}
                                 style="width: 70%; border-radius: 20%" {% else %}
                                 style="width: 80%; border-radius: 20%"
                            {% endif %}>
                        {% endif %}
                    </div>
                </div>

                <div class="col-10 col-sm-11">
                    <div style="color: gray;">
                        <span {% if user == node.user %} class="font_gradient" {% endif %}
                                                         style="font-weight: bold;">{{ node.user }}</span>
                        {% if node.user.is_superuser %}
                            <i style="color: #ff5500;">[博主]</i>
                        {% elif node.user.is_staff %}
                            <i style="color: #5897fb;">[管理员]</i>
                        {% endif %}
                        {% if node.reply_to %}
                            <i class="far fa-arrow-alt-circle-right" style="color: cornflowerblue;"></i>
                            <span {% if user == node.reply_to %}
                                class="font_gradient" {% endif %}
                                style="font-weight: bold;">{{ node.reply_to }}</span>
                            {% if node.reply_to.is_superuser %}
                                <i style="color: #ff5500;">[博主]</i>
                            {% elif node.reply_to.is_staff %}
                                <i style="color: #5897fb;">[管理员]</i>
                            {% endif %}
                        {% endif %}
                        <span>
                            <a href="javascript:"
{#                               onclick="increase_likes('{% url 'extends:increase_likes' 'comment' node.id %}', {{ node.id }}, {{ node.likes }})"#}
                               class="no-underline hvr-icon-grow-rotate"
                               style="color: pink"
                            >
                                <button class="icobutton icobutton--heart icobutton_{{ node.id }}"
                                        onclick="animocons_handler(this, '{% url 'extends:increase_likes' 'comment' node.id %}', {{ node.id }}, {{ node.likes }})">
                                    <i class="fas fa-heart heart_item" data-id="{{ node.id }}"></i>
                                    <span id="likes_{{ node.id }}">{{ node.likes }}</span>
                                </button>
                            </a>
                        </span>
                    </div>

                    <!-- 正文 -->
                    {% if node.is_deleted %}
                        {% if node.is_deleted_by_staff %}
                            <div style="text-align: center;" class="alert alert-danger">
                                本回复已被 [博主] 删除
                            </div>
                        {% else %}

                            <div style="text-align: center;" class="alert alert-danger">
                                本回复已被 {{ node.user }} 删除
                            </div>
                        {% endif %} {% else %}
                        <div id="comment_body_div">
                            <div class="comment-hidden" id="comment_body_{{ node.id }}" style="max-height: 500px;">
                                <p class="mt-3 mb-1">{{ node.body|safe }}</p>
                            </div>
                            <div class="text-center link_elem_{{ node.id }}" id="gradient_layer">
                                <a href="javascript:" onclick="unfoldContent(this)" id="unfold_link"
                                   style="font-size: 1.1em; position: relative; top: 80px;">
                                    展开内容..
                                </a>
                            </div>

                        </div>
                    {% endif %}

                    <!-- 附加信息 -->
                    <div style="color: #999999;">
                        <p>{{ node.created_time|timesince_zh }}
                            <a href="{% url 'comments:reply_post_comment' article.id node.id article_type %}"
                               style="color: #01a252"
                               class="hvr-grow-rotate no-underline"
                            >
                                回复
                            </a>

                            <!-- 删除/编辑 -->
                            {% if node.user == user or user.is_staff %}
                                {% if not node.is_deleted %}
                                    <a href="{% url 'comments:edit' node.id %}?article_type={{ article_type }}"
                                       style="color: lightskyblue;"
                                       class="hvr-grow-rotate no-underline"
                                    >
                                        编辑
                                    </a>
                                    <span style="float: right">
                            <a href="javascript:" title="删除" onclick="confirm_delete({{ node.id }});">
                                <i class="far fa-trash-alt hvr-buzz-out" style="color: darkred;"></i>
                            </a>
                        </span>
                                {% endif %}
                            {% endif %}
                        </p>
                    </div>

                    {% if not node.is_leaf_node %}


                        <a class="btn btn-outline-secondary" data-toggle="collapse" href="#collapse_{{ node.id }}"
                           role="button"
                           aria-expanded="false" aria-controls="collapse_{{ node.id }}"
                           onclick="onUnfoldContent(this, {{ node.id }})" id="collapse_link">
                            展开此讨论..
                        </a>
                        <!-- 此处调用了jquery.prev() -->
                        <div class="collapse" id="collapse_{{ node.id }}">
                            <div class="card card-body">
                                <div class="children">
                                    {{ children }}
                                </div>
                            </div>
                        </div>

                    {% endif %}
                </div>
            </div>
        {% endrecursetree %}
    </div>
</div>


{% block script %}
<script>
    // validate and record likes
    const increase_likes = (self, url, node_id, node_likes) => {
        let storage = window.localStorage;
        {#storage.clear();#}
        const storage_str_data = storage.getItem("dusaiphoto_data");
        let storage_json_data = JSON.parse(storage_str_data);

        // 是否存在localStorage.comments
        if (!storage_json_data) {
            storage_json_data = {
                comments: {}
            }
        }

        if (storage_json_data.comments[node_id] && storage_json_data.comments[node_id].is_like) {
            layer.msg('已经点过赞了');
            return true;
        }

        $(self).find('span').text(node_likes + 1);
        layer.msg('么么哒~');

        $.get(url, function (result) {
            // 后台返回 success/fail
            if (result.state === 200) {
                storage_json_data.comments[node_id] = {};
                storage_json_data.comments[node_id]["is_like"] = true;
                const d = JSON.stringify(storage_json_data);
                try {
                    storage.setItem("dusaiphoto_data", d);
                } catch (e) {
                    // QUOTA_EXCEEDED_ERR_CODE = 22
                    if (e.code === 22) {
                        localStorage.clear();
                        storage.setItem("dusaiphoto_data", d);
                    }
                }

            } else {
                layer.msg('与服务器通信失败..过一会儿再试试吧~');
            }
        });
    };

    // run animation
    const animocons = (self) => {
        var el16 = $(self), el16span = el16.find('i');
        var opacityCurve16 = mojs.easing.path('M0,0 L25.333,0 L75.333,100 L100,0');
        var translationCurve16 = mojs.easing.path('M0,100h25.3c0,0,6.5-37.3,15-56c12.3-27,35-44,35-44v150c0,0-1.1-12.2,9.7-33.3c9.7-19,15-22.9,15-22.9');
        var squashCurve16 = mojs.easing.path('M0,100.004963 C0,100.004963 25,147.596355 25,100.004961 C25,70.7741867 32.2461944,85.3230873 58.484375,94.8579105 C68.9280825,98.6531013 83.2611815,99.9999999 100,100');

        let timeline = new mojs.Timeline();

        let tweens1 = new mojs.Burst({
            parent: el16,
            count: 6,
            radius: {0: 150},
            degree: 50,
            angle: -25,
            opacity: 0.3,
            children: {
                fill: '#FF6767',
                scale: 1,
                radius: {'rand(5,15)': 0},
                duration: 1700,
                delay: 350,
                easing: mojs.easing.bezier(0.1, 1, 0.3, 1)
            },

        });
        let tweens2 = new mojs.Burst({
            parent: el16,
            count: 3,
            degree: 0,
            radius: {80: 250},
            angle: 180,
            children: {
                top: [45, 0, 45],
                left: [-15, 0, 15],
                shape: 'line',
                radius: {60: 0},
                scale: 1,
                stroke: '#FF6767',
                opacity: 0.4,
                duration: 650,
                delay: 200,
                easing: mojs.easing.bezier(0.1, 1, 0.3, 1)
            },

        });
        // icon scale animation
        let tweens3 = new mojs.Tween({
            duration: 500,
            onUpdate: function (progress) {
                var translateProgress = translationCurve16(progress),
                    squashProgress = squashCurve16(progress),
                    scaleX = 1 - 2 * squashProgress,
                    scaleY = 1 + 2 * squashProgress;

                el16span.css('transform', 'translate3d(0,' + -180 * translateProgress + 'px,0) scale3d(' + scaleX + ',' + scaleY + ',1)');

                var opacityProgress = opacityCurve16(progress);
                el16span.css('opacity', opacityProgress);

                el16.css('color', progress >= 0.75 ? '#FF6767' : '#C0C1C3');
            },

        });

        timeline.add(tweens1, tweens2, tweens3);
        timeline.replay();

        window.setTimeout(clear_element.bind(null, el16), 1500)
    };

    // 清除shape元素
    const clear_element = (el) => {
        const animation_el = $(el).find('[data-name=mojs-shape]');
        console.log(el);
        animation_el.remove();
    };

    // increase likes handler
    const animocons_handler = (self, url, node_id, node_likes) => {
        const is_liked = increase_likes(self, url, node_id, node_likes);
        if(!is_liked) {
            animocons(self);
        }
    };

    // 点赞初始渲染
    $(() => {
        let storage = window.localStorage;
        const storage_str_data = storage.getItem("dusaiphoto_data");
        let storage_json_data = JSON.parse(storage_str_data);
        $('i.heart_item').each(function (index, element) {
            let item = $(element);
            let node_id = item.attr('data-id');
            if(node_id in storage_json_data.comments) {
                item.css('color', 'red');
            }
        });

    })


</script>

    <!-- ckeditor -->
    <script type="text/javascript"
            src="{% static 'ckeditor/ckeditor/plugins/prism/lib/prism/prism_patched.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'ckeditor/ckeditor-init.js' %}"></script>
    <script type="text/javascript" src="{% static 'ckeditor/ckeditor/ckeditor.js' %}"></script>
    <script>
        $(".django-ckeditor-widget").removeAttr('style');
    </script>

    <script>

        // 删除文章的函数
        const confirm_delete = function (node_id) {
            layer.open({
                title: "当心！",
                content: "确认删除此回复吗？",
                shadeClose: true,
                anim: 6,
                yes: function (index, layero) {
                    location.href = "{% url 'comments:soft_delete' %}?" +
                        "comment_id=" + node_id +
                        "&" + "article_type=" + "{{ article_type }}"
                },
            })
        };

        // 展开根评论 height <= 500px 时
        const unfoldContent = (node_id) => {
            const comment_body = $("#comment_body_" + node_id);
            const link_elem = $(".link_elem_" + node_id);
            if (comment_body.height() <= 500) {
                comment_body.css('max-height', '');
                link_elem.hide();
            }
        };

        // 展开根评论及子评论
        const onUnfoldContent = (self, node_id) => {
            if ($(self).attr('aria-expanded') === 'false') {
                unfoldContent(node_id);
            }
        };

        $(() => {
            // 展开根评论
            const comment_body_divs = $('div#comment_body_div');
            const unfold_links = $('a#unfold_link');
            for (const div of comment_body_divs) {
                let comment_body_height = $(div).children('.comment-hidden').height();
                if (comment_body_height < 500) {
                    $(div).children('div#gradient_layer').hide();
                }
            }
            // 子评论解除隐藏
            const children_comments = $('.children').find('.comment-hidden').css('max-height', '');

            // 展开/渲染评论锚点
            const aQuery = window.location.href.split("#")[1];
            const comment_selector = $('#' + aQuery);
            comment_selector.parents('.collapse').collapse();
            comment_selector.attr('style', 'border-left: 4px solid #FF8C00');

            // 登录提示
            $('#github_a').on('mouseenter', function () {
                this.index = layer.tips('以Github账号登录', this, {
                    time: -1,
                    maxWidth: 280,
                    tips: [3, 'dimgray']
                });
            }).on('mouseleave', function () {
                layer.close(this.index);
            });
            $('#weibo_a').on('mouseenter', function () {
                this.index = layer.tips('以新浪微博账号登录', this, {
                    time: -1,
                    maxWidth: 280,
                    tips: [3, 'indianred']
                });
            }).on('mouseleave', function () {
                layer.close(this.index);
            });
        });
    </script>
{% endblock %}